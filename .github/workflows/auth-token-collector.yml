name: Qwen Code Multi-Account Token Collection

on:
  workflow_dispatch:
    inputs:
      num_accounts:
        description: 'Number of Qwen Code accounts to authenticate'
        required: true
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'
          - '10'
      encryption_password:
        description: 'Password for encrypting tokens (remember this!)'
        required: true
        type: string

jobs:
  collect-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install CLIProxyAPI
        run: |
          git clone https://github.com/router-for-me/CLIProxyAPI.git
          cd CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo mv cli-proxy-api /usr/local/bin/
          cd ..
          rm -rf CLIProxyAPI

      - name: Create auth directory
        run: |
          # Create the main auth directory
          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"
          
          # Create separate directories for each account
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            ACCOUNT_DIR="$AUTH_DIR/account-$i"
            mkdir -p "$ACCOUNT_DIR"
            chmod 700 "$ACCOUNT_DIR"
            echo "Created directory for account $i: $ACCOUNT_DIR"
          done
          
          # Verify main directory exists
          if [ ! -d "$AUTH_DIR" ]; then
            echo "Failed to create auth directory"
            exit 1
          fi
          
          # Create the auth-urls directory
          mkdir -p ./auth-urls
          
          echo ""
          echo "Auth directory structure:"
          ls -la "$AUTH_DIR"
          echo ""
          ls -la "$AUTH_DIR"/*/ 2>/dev/null || true

      - name: Create minimal config file
        run: |
          # Create a separate config file for each account with its own auth-dir
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            cat > config-account-$i.yaml << EOF
          port: $((8080 + i - 1))
          auth-dir: "$HOME/.cli-proxy-api/account-$i"
          debug: false
          EOF
            
            echo "Config file created for account $i:"
            cat config-account-$i.yaml
            echo ""
          done

      - name: Generate login URLs for all accounts
        run: |
          echo "=========================================="
          echo "QWEN CODE AUTHENTICATION URLS"
          echo "=========================================="
          echo ""
          
          echo "Generating login URLs for all ${{ github.event.inputs.num_accounts }} accounts..."
          echo ""
          echo "âš ï¸  IMPORTANT: Complete each OAuth flow within 5 minutes"
          echo ""
          
          # Generate login URL for each account
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“± ACCOUNT $i LOGIN URL:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Use account-specific config file
            CONFIG_PATH="$(pwd)/config-account-$i.yaml"
            
            if [ ! -f "$CONFIG_PATH" ]; then
              echo "Error: Config file not found at $CONFIG_PATH"
              exit 1
            fi
            
            # Trigger Qwen login with account-specific config
            (timeout 10s cli-proxy-api -config "$CONFIG_PATH" -qwen-login -no-browser 2>&1 || true) | tee login-$i.log &
            LOGIN_PID=$!
            
            # Wait for the URL to be generated
            sleep 3
            
            # Extract the OAuth URL from logs
            if [ -f login-$i.log ]; then
              URL=$(grep -oP 'https://[^\s]+' login-$i.log | head -1 || echo "Generating...")
              echo "$URL"
            fi
            
            # Save URL to file
            grep -oP 'https://[^\s]+' login-$i.log | head -1 > ./auth-urls/account-$i-url.txt || true
            
            echo ""
            
            # Just a short wait before generating next URL
            sleep 2
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… All ${{ github.event.inputs.num_accounts }} login URLs generated!"
          echo ""
          echo "ðŸ‘† Open all URLs above in separate tabs and complete the authentication"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â° Waiting for all OAuth flows to complete..."
          echo "Maximum wait time: 10 minutes"
          echo ""
          echo "ðŸ’¡ TIP: You can authenticate all accounts simultaneously in different browser tabs"
          echo ""
          
          # Monitor for token files with timeout
          EXPECTED_TOKENS=${{ github.event.inputs.num_accounts }}
          MAX_WAIT=600  # 10 minutes in seconds
          ELAPSED=0
          CHECK_INTERVAL=5  # Check every 5 seconds
          
          echo "Monitoring for $EXPECTED_TOKENS token file(s)..."
          echo ""
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Count current token files across all account directories
            CURRENT_TOKENS=0
            for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
              if ls ~/.cli-proxy-api/account-$i/qwen-*.json 2>/dev/null | grep -q .; then
                CURRENT_TOKENS=$((CURRENT_TOKENS + 1))
              fi
            done
            
            if [ "$CURRENT_TOKENS" -ge "$EXPECTED_TOKENS" ]; then
              echo ""
              echo "ðŸŽ‰ All $EXPECTED_TOKENS accounts authenticated successfully!"
              echo "Total time: ${ELAPSED} seconds"
              break
            fi
            
            # Show progress every 15 seconds
            if [ $((ELAPSED % 15)) -eq 0 ]; then
              echo "â³ Progress: $CURRENT_TOKENS/$EXPECTED_TOKENS accounts authenticated (${ELAPSED}s elapsed)"
            fi
            
            sleep $CHECK_INTERVAL
            ELAPSED=$((ELAPSED + CHECK_INTERVAL))
          done
          
          # Final check - count tokens across all account directories
          FINAL_COUNT=0
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            if ls ~/.cli-proxy-api/account-$i/qwen-*.json 2>/dev/null | grep -q .; then
              FINAL_COUNT=$((FINAL_COUNT + 1))
            fi
          done
          
          if [ "$FINAL_COUNT" -lt "$EXPECTED_TOKENS" ]; then
            echo ""
            echo "âš ï¸  Timeout reached. Found $FINAL_COUNT/$EXPECTED_TOKENS tokens."
            echo "You can still proceed, but some accounts may be missing."
          fi
          
          echo ""
          echo "â±ï¸  Authentication monitoring complete. Collecting tokens..."

      - name: Display all authentication URLs in summary
        run: |
          echo "## ðŸ” Qwen Code Authentication URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Complete the OAuth flow for each account by clicking the URLs below:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "### Account $i" >> $GITHUB_STEP_SUMMARY
            if [ -f ./auth-urls/account-$i-url.txt ]; then
              URL=$(cat ./auth-urls/account-$i-url.txt)
              echo "- [ðŸ”— Click here to login]($URL)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸  URL not generated - check logs" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "â° **Complete all logins within 10 minutes**" >> $GITHUB_STEP_SUMMARY

      - name: Verify collected tokens
        run: |
          echo "Verifying collected tokens..."
          echo ""
          
          # Check each account directory
          TOKEN_COUNT=0
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            ACCOUNT_DIR="$HOME/.cli-proxy-api/account-$i"
            if ls "$ACCOUNT_DIR"/qwen-*.json 2>/dev/null | grep -q .; then
              TOKEN_COUNT=$((TOKEN_COUNT + 1))
              echo "âœ… Account $i: Token found"
              ls -la "$ACCOUNT_DIR"/qwen-*.json
            else
              echo "âŒ Account $i: No token found"
            fi
          done
          
          echo ""
          echo "Total tokens collected: $TOKEN_COUNT/${{ github.event.inputs.num_accounts }}"
          echo ""
          
          if [ "$TOKEN_COUNT" -eq "0" ]; then
            echo "âŒ No tokens found!"
            echo "OAuth authentication was not completed."
            echo ""
            echo "Please run the workflow again and make sure to:"
            echo "1. Click all the generated OAuth URLs"
            echo "2. Complete the authentication in your browser"
            echo "3. Wait for the 'authenticated successfully' message"
            echo ""
            exit 1
          fi
          
          if [ "$TOKEN_COUNT" -lt "${{ github.event.inputs.num_accounts }}" ]; then
            echo "âš ï¸  Warning: Expected ${{ github.event.inputs.num_accounts }} tokens but found $TOKEN_COUNT"
            echo "Some OAuth flows may not have completed successfully."
            echo "The workflow will continue with the tokens that were collected."
            echo ""
          else
            echo "ðŸŽ‰ All expected tokens collected successfully!"
            echo ""
          fi

      - name: Collect and encrypt tokens
        run: |
          echo "Collecting tokens from all account directories..."
          echo ""
          
          # Create a temporary directory to collect all tokens
          TEMP_DIR=$(mktemp -d)
          
          # Copy all token files to temp directory with unique names
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            ACCOUNT_DIR="$HOME/.cli-proxy-api/account-$i"
            if ls "$ACCOUNT_DIR"/qwen-*.json 2>/dev/null | grep -q .; then
              # Rename token to include account number to avoid conflicts
              cp "$ACCOUNT_DIR"/qwen-*.json "$TEMP_DIR/qwen-account-$i.json"
              echo "âœ… Collected token from account $i"
            fi
          done
          
          # Verify we have tokens
          TOKEN_COUNT=$(ls "$TEMP_DIR"/qwen-*.json 2>/dev/null | wc -l)
          if [ "$TOKEN_COUNT" -eq "0" ]; then
            echo "âŒ No tokens to encrypt!"
            exit 1
          fi
          
          echo ""
          echo "Tokens to be encrypted:"
          ls -la "$TEMP_DIR"/qwen-*.json
          echo ""
          
          # Create tarball of all collected tokens
          cd "$TEMP_DIR"
          tar -czf qwen-tokens.tar.gz qwen-*.json
          echo "âœ… Tokens collected in tarball"
          
          # Use user-provided password for encryption
          USER_PASSWORD="${{ github.event.inputs.encryption_password }}"
          
          # Encrypt the tokens
          echo "$USER_PASSWORD" | openssl enc -aes-256-cbc -salt -pbkdf2 -in qwen-tokens.tar.gz -out qwen-tokens.enc -pass stdin
          echo "âœ… Tokens encrypted with your password"
          
          # Base64 encode for GitHub Secrets
          base64 -w 0 qwen-tokens.enc > qwen-tokens.b64
          echo "âœ… Tokens base64 encoded"
          
          # Move the final file to home directory for later access
          mv qwen-tokens.b64 "$HOME/"
          
          # Display results
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ENCRYPTED TOKENS READY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Number of accounts: $TOKEN_COUNT"
          echo "Encrypted token size: $(stat -c%s "$HOME/qwen-tokens.b64") bytes"
          echo ""
          
          # Cleanup temp directory
          rm -rf "$TEMP_DIR"

      - name: Prepare GitHub Secrets instructions
        run: |
          # Read the encrypted token from home directory
          ENCRYPTED_TOKEN=$(cat "$HOME/qwen-tokens.b64")
          
          echo "## ðŸŽ‰ Tokens Successfully Collected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your Qwen Code tokens have been encrypted and are ready to upload to GitHub Secrets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to your repository **Settings** â†’ **Secrets and variables** â†’ **Actions**" >> $GITHUB_STEP_SUMMARY
          echo "2. Click **New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "3. Create the following secret:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Secret Name: \`QWEN_TOKENS\`" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$ENCRYPTED_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** Remember your encryption password - you'll need it to decrypt!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… After creating this secret, use the **CLIProxyAPI Server** workflow to start your API endpoint!" >> $GITHUB_STEP_SUMMARY

      - name: Upload token files as artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: qwen-encrypted-tokens
          path: ~/qwen-tokens.b64
          retention-days: 1