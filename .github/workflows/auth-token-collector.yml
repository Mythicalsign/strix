name: Qwen Code Multi-Account Token Collection

on:
  workflow_dispatch:
    inputs:
      num_accounts:
        description: 'Number of Qwen Code accounts to authenticate'
        required: true
        default: '3'
        type: choice
        options:
          - '1'
          - '2'
          - '3'
          - '4'
          - '5'
          - '6'
          - '7'
          - '8'
          - '9'
          - '10'
      encryption_password:
        description: 'Password for encrypting tokens (remember this!)'
        required: true
        type: string

jobs:
  collect-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install CLIProxyAPI
        run: |
          git clone https://github.com/router-for-me/CLIProxyAPI.git
          cd CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo mv cli-proxy-api /usr/local/bin/
          cd ..
          rm -rf CLIProxyAPI

      - name: Create auth directory
        run: |
          # Create the auth directory with full path
          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"
          
          # Verify it exists
          if [ ! -d "$AUTH_DIR" ]; then
            echo "Failed to create auth directory"
            exit 1
          fi
          
          # Create the auth-urls directory
          mkdir -p ./auth-urls
          
          echo "Auth directory created at: $AUTH_DIR"
          ls -la "$AUTH_DIR"

      - name: Create minimal config file
        run: |
          # CLIProxyAPI requires a config file even for login commands
          cat > config.yaml << EOF
          port: 8080
          auth-dir: "$HOME/.cli-proxy-api"
          debug: false
          EOF
          
          echo "Config file created:"
          cat config.yaml

      - name: Generate login URLs directly (no server needed)
        run: |
          echo "=========================================="
          echo "QWEN CODE AUTHENTICATION URLS"
          echo "=========================================="
          echo ""
          echo "Generating login URLs for all ${{ github.event.inputs.num_accounts }} accounts..."
          echo ""
          echo "âš ï¸  IMPORTANT: Complete each OAuth flow within 5 minutes"
          echo ""
          
          # Get the full path to config file
          CONFIG_PATH="$(pwd)/config.yaml"
          echo "Using config at: $CONFIG_PATH"
          
          # Verify config exists
          if [ ! -f "$CONFIG_PATH" ]; then
            echo "Error: Config file not found at $CONFIG_PATH"
            exit 1
          fi
          echo ""
          
          # Generate login URL for each account
          echo "Generating login URLs for all ${{ github.event.inputs.num_accounts }} accounts..."
          echo ""
          
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“± ACCOUNT $i LOGIN URL:"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Trigger Qwen login with explicit config path
            (timeout 10s cli-proxy-api -config "$CONFIG_PATH" -qwen-login -no-browser 2>&1 || true) | tee login-$i.log &
            LOGIN_PID=$!
            
            # Wait for the URL to be generated
            sleep 3
            
            # Extract the OAuth URL from logs
            if [ -f login-$i.log ]; then
              URL=$(grep -oP 'https://[^\s]+' login-$i.log | head -1 || echo "Generating...")
              echo "$URL"
            fi
            
            # Save URL to file
            grep -oP 'https://[^\s]+' login-$i.log | head -1 > ./auth-urls/account-$i-url.txt || true
            
            echo ""
            
            # Just a short wait before generating next URL
            sleep 2
          done
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… All ${{ github.event.inputs.num_accounts }} login URLs generated!"
          echo ""
          echo "ðŸ‘† Open all URLs above in separate tabs and complete the authentication"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "â° Waiting 5 minutes for all OAuth flows to complete..."
          echo "You have until $(date -d '+5 minutes' '+%H:%M:%S') to finish all logins"
          echo ""
          echo "ðŸ’¡ TIP: You can authenticate all accounts simultaneously in different browser tabs"
          echo ""
          
          # Wait 5 minutes for all OAuth completions
          sleep 300
          
          echo ""
          echo "â±ï¸  Authentication window closed. Collecting tokens..."

      - name: Display all authentication URLs in summary
        run: |
          echo "## ðŸ” Qwen Code Authentication URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Complete the OAuth flow for each account by clicking the URLs below:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "### Account $i" >> $GITHUB_STEP_SUMMARY
            if [ -f ./auth-urls/account-$i-url.txt ]; then
              URL=$(cat ./auth-urls/account-$i-url.txt)
              echo "- [ðŸ”— Click here to login]($URL)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âš ï¸  URL not generated - check logs" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "â° **Complete all logins within 10 minutes**" >> $GITHUB_STEP_SUMMARY

      - name: Verify collected tokens
        run: |
          echo "Checking for authenticated tokens..."
          echo ""
          
          TOKEN_COUNT=$(ls ~/.cli-proxy-api/qwen-*.json 2>/dev/null | wc -l)
          
          if [ "$TOKEN_COUNT" -eq "0" ]; then
            echo "âŒ No tokens found!"
            echo "Please make sure you completed the OAuth flows."
            ls -la ~/.cli-proxy-api/
            exit 1
          fi
          
          echo "âœ… Found $TOKEN_COUNT token file(s):"
          ls -la ~/.cli-proxy-api/qwen-*.json
          
          if [ "$TOKEN_COUNT" -lt "${{ github.event.inputs.num_accounts }}" ]; then
            echo ""
            echo "âš ï¸  Warning: Expected ${{ github.event.inputs.num_accounts }} tokens but found $TOKEN_COUNT"
            echo "Some OAuth flows may not have completed successfully."
          fi

      - name: Collect and encrypt tokens
        run: |
          cd ~/.cli-proxy-api
          
          # Create tarball of all Qwen tokens
          tar -czf qwen-tokens.tar.gz qwen-*.json
          echo "âœ… Tokens collected in tarball"
          
          # Use user-provided password for encryption
          USER_PASSWORD="${{ github.event.inputs.encryption_password }}"
          
          # Encrypt the tokens
          echo "$USER_PASSWORD" | openssl enc -aes-256-cbc -salt -pbkdf2 -in qwen-tokens.tar.gz -out qwen-tokens.enc -pass stdin
          echo "âœ… Tokens encrypted with your password"
          
          # Base64 encode for GitHub Secrets
          base64 -w 0 qwen-tokens.enc > qwen-tokens.b64
          echo "âœ… Tokens base64 encoded"
          
          # Display results
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“¦ ENCRYPTED TOKENS READY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Encrypted token size: $(stat -c%s qwen-tokens.b64) bytes"
          echo ""

      - name: Prepare GitHub Secrets instructions
        run: |
          cd ~/.cli-proxy-api
          
          # Read the encrypted token
          ENCRYPTED_TOKEN=$(cat qwen-tokens.b64)
          
          echo "## ðŸŽ‰ Tokens Successfully Collected!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your Qwen Code tokens have been encrypted and are ready to upload to GitHub Secrets." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Instructions:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to your repository **Settings** â†’ **Secrets and variables** â†’ **Actions**" >> $GITHUB_STEP_SUMMARY
          echo "2. Click **New repository secret**" >> $GITHUB_STEP_SUMMARY
          echo "3. Create the following secret:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Secret Name: \`QWEN_TOKENS\`" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "$ENCRYPTED_TOKEN" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Important:** Remember your encryption password - you'll need it to decrypt!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… After creating this secret, use the **CLIProxyAPI Server** workflow to start your API endpoint!" >> $GITHUB_STEP_SUMMARY

      - name: Upload token files as artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: qwen-encrypted-tokens
          path: ~/.cli-proxy-api/qwen-tokens.b64
          retention-days: 1