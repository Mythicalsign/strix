name: Qwen Code Multi-Account Token Collection

on:
  workflow_dispatch:
    inputs:
      num_accounts:
        description: 'Number of Qwen Code accounts to authenticate'
        required: true
        default: '3'
        type: choice
        options: ['1','2','3','4','5','6','7','8','9','10']
      encryption_password:
        description: 'Password for encrypting tokens (remember this!)'
        required: true
        type: string

jobs:
  collect-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      # ---------- 1. Checkout repository ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- 2. Setup Go for building CLIProxyAPI ----------
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # ---------- 3. Install expect and other tools ----------
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y expect

      # ---------- 4. Install CLIProxyAPI ----------
      - name: Install CLIProxyAPI
        run: |
          set -euo pipefail
          echo "::group::Installing CLIProxyAPI"
          git clone --depth 1 https://github.com/router-for-me/CLIProxyAPI.git /tmp/CLIProxyAPI
          cd /tmp/CLIProxyAPI
          go build -o cli-proxy-api ./cmd/server
          sudo mv cli-proxy-api /usr/local/bin/cliproxyapi
          cd /
          rm -rf /tmp/CLIProxyAPI
          cliproxyapi --help
          echo "::endgroup::"

      # ---------- 5. Validate aliases secret ----------
      - name: Validate QWEN_ALIASES secret
        env:
          QWEN_ALIASES: ${{ secrets.QWEN_ALIASES }}
        run: |
          set -euo pipefail
          if [ -z "$QWEN_ALIASES" ]; then
            echo "::error::QWEN_ALIASES secret is not set!"
            echo "Please set the QWEN_ALIASES secret with comma-separated aliases (e.g., 'john,jane,alex')"
            exit 1
          fi
          
          IFS=',' read -r -a ALIAS_ARRAY <<< "$QWEN_ALIASES"
          NEEDED=${{ github.event.inputs.num_accounts }}
          
          echo "Found ${#ALIAS_ARRAY[@]} aliases in QWEN_ALIASES secret"
          echo "Requested accounts: $NEEDED"
          
          if [ "${#ALIAS_ARRAY[@]}" -lt "$NEEDED" ]; then
            echo "::error::QWEN_ALIASES contains ${#ALIAS_ARRAY[@]} aliases, but $NEEDED accounts requested!"
            exit 1
          fi
          
          echo "âœ… Alias validation passed"

      # ---------- 6. Create auth directory structure ----------
      - name: Create auth directory structure
        run: |
          set -euo pipefail
          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"
          echo "AUTH_DIR=$AUTH_DIR" >> "$GITHUB_ENV"
          echo "âœ… Auth directory created: $AUTH_DIR"

      # ---------- 7. Create config file ----------
      - name: Create CLIProxyAPI config
        run: |
          set -euo pipefail
          cat > "$AUTH_DIR/config.yaml" << EOF
          port: 8317
          auth-dir: "$AUTH_DIR"
          debug: true
          logging-to-file: true
          EOF
          echo "Config file created:"
          cat "$AUTH_DIR/config.yaml"

      # ---------- 8. Authenticate accounts sequentially ----------
      - name: Authenticate accounts sequentially
        env:
          QWEN_ALIASES: ${{ secrets.QWEN_ALIASES }}
        run: |
          set -euo pipefail
          
          # Parse aliases
          IFS=',' read -r -a ALIAS_ARRAY <<< "$QWEN_ALIASES"
          NEEDED=${{ github.event.inputs.num_accounts }}
          
          echo "=========================================="
          echo "Starting authentication for $NEEDED accounts"
          echo "=========================================="
          
          COLLECTED=0
          
          for i in $(seq 1 "$NEEDED"); do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“± AUTHENTICATING ACCOUNT $i / $NEEDED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Get alias for this account (zero-based array)
            CURRENT_ALIAS="${ALIAS_ARRAY[$((i-1))]}"
            CURRENT_ALIAS=$(echo "$CURRENT_ALIAS" | xargs)  # Trim whitespace
            
            echo "Using alias: $CURRENT_ALIAS"
            
            # Create log file for this account
            LOG_FILE="/tmp/cliproxy-$i.log"
            EXPECT_SCRIPT="/tmp/auth-$i.exp"
            
            # Create expect script that will:
            # 1. Start CLIProxyAPI and wait for the OAuth URL
            # 2. Wait for the alias prompt after user authenticates
            # 3. Send the alias automatically
            cat > "$EXPECT_SCRIPT" << EXPECT_EOF
          #!/usr/bin/expect -f
          set timeout 660
          set alias "$CURRENT_ALIAS"
          
          # Start CLIProxyAPI
          spawn cliproxyapi -config "$AUTH_DIR/config.yaml" -qwen-login -no-browser
          
          # Log file for capturing output
          log_file -noappend "$LOG_FILE"
          
          # Wait for the alias prompt (this appears after OAuth completes)
          # The prompt is: "Please input your email address or alias for Qwen:"
          expect {
              -re {Please input your email address or alias} {
                  # Small delay before sending
                  sleep 1
                  send "\$alias\r"
                  exp_continue
              }
              -re {Authentication saved to} {
                  # Success! Token was saved
                  puts "\nâœ… Authentication successful!"
              }
              -re {authentication successful} {
                  # Success message
                  puts "\nâœ… Authentication completed!"
              }
              timeout {
                  puts "\nâ° Timeout waiting for authentication"
                  exit 1
              }
              eof {
                  puts "\nðŸ“ Process ended"
              }
          }
          
          # Give it a moment to finish writing files
          sleep 2
          EXPECT_EOF
            
            chmod +x "$EXPECT_SCRIPT"
            
            # Run expect script in background
            $EXPECT_SCRIPT > /tmp/expect-$i.log 2>&1 &
            EXPECT_PID=$!
            
            echo "Started authentication process (PID: $EXPECT_PID)"
            
            # Wait for OAuth URL to appear in log
            echo "Waiting for OAuth URL..."
            URL=""
            for retry in {1..60}; do
              if [ -f "$LOG_FILE" ]; then
                URL=$(grep -oP 'https://chat\.qwen\.ai/authorize[^\s"]+' "$LOG_FILE" 2>/dev/null | head -1 || true)
                if [ -n "$URL" ]; then
                  break
                fi
              fi
              sleep 2
            done
            
            if [ -z "$URL" ]; then
              echo "::warning::No OAuth URL found for account $i"
              echo "Log contents:"
              cat "$LOG_FILE" 2>/dev/null || echo "(empty log)"
              cat /tmp/expect-$i.log 2>/dev/null || echo "(empty expect log)"
              kill $EXPECT_PID 2>/dev/null || true
              continue
            fi
            
            echo ""
            echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "â•‘  ðŸ”— AUTHENTICATION URL FOR ACCOUNT $i                        â•‘"
            echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
            echo "â•‘  Open this URL in your browser and log in:                   â•‘"
            echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            echo "   $URL"
            echo ""
            echo "â³ Waiting for authentication (timeout: 10 minutes)..."
            echo "   Alias '$CURRENT_ALIAS' will be automatically entered."
            echo ""
            
            # Wait for token file to appear OR for expect process to complete
            TOKEN_FILE=""
            for s in {1..600}; do
              # Check if expect process is still running
              if ! kill -0 $EXPECT_PID 2>/dev/null; then
                echo "Authentication process ended"
                # Check if it was successful
                if grep -q "Authentication saved to\|authentication successful" /tmp/expect-$i.log 2>/dev/null; then
                  echo "âœ… Authentication completed successfully"
                fi
                break
              fi
              
              # Look for the token file
              TOKEN_FILE=$(find "$AUTH_DIR" -maxdepth 1 -name "qwen-*.json" -newer "$LOG_FILE" -print -quit 2>/dev/null || true)
              if [ -n "$TOKEN_FILE" ]; then
                echo "âœ… Token file created: $(basename "$TOKEN_FILE")"
                COLLECTED=$((COLLECTED + 1))
                # Kill the expect process since we got the token
                kill $EXPECT_PID 2>/dev/null || true
                break
              fi
              
              # Show progress every 30 seconds
              if [ $((s % 30)) -eq 0 ]; then
                echo "   Still waiting... ($s seconds elapsed)"
              fi
              
              sleep 1
            done
            
            # Clean up the expect process if still running
            kill $EXPECT_PID 2>/dev/null || true
            wait $EXPECT_PID 2>/dev/null || true
            
            # Final check for token file
            if [ -z "$TOKEN_FILE" ]; then
              TOKEN_FILE=$(find "$AUTH_DIR" -maxdepth 1 -name "qwen-*.json" -print -quit 2>/dev/null || true)
              if [ -n "$TOKEN_FILE" ]; then
                echo "âœ… Token file found: $(basename "$TOKEN_FILE")"
                COLLECTED=$((COLLECTED + 1))
              else
                echo "::warning::No token file found for account $i"
                echo "Expect log contents:"
                tail -50 /tmp/expect-$i.log 2>/dev/null || echo "(no expect log)"
                echo "CLIProxyAPI log contents:"
                tail -50 "$LOG_FILE" 2>/dev/null || echo "(no log)"
              fi
            fi
            
            # Clean up temp files
            rm -f "$EXPECT_SCRIPT" /tmp/expect-$i.log
            
            # Brief pause between accounts
            if [ "$i" -lt "$NEEDED" ]; then
              echo "â¸ï¸ Pausing 5 seconds before next account..."
              sleep 5
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "Authentication phase complete"
          echo "Tokens collected: $COLLECTED / $NEEDED"
          echo "=========================================="
          
          # Set output for next steps
          echo "TOKENS_COLLECTED=$COLLECTED" >> "$GITHUB_ENV"

      # ---------- 9. Verify tokens ----------
      - name: Verify collected tokens
        run: |
          set -euo pipefail
          
          echo "::group::Verifying collected tokens"
          
          TOKEN_COUNT=$(find "$AUTH_DIR" -maxdepth 1 -name 'qwen-*.json' 2>/dev/null | wc -l)
          NEEDED=${{ github.event.inputs.num_accounts }}
          
          echo "Token files found: $TOKEN_COUNT"
          echo "Tokens requested: $NEEDED"
          
          if [ "$TOKEN_COUNT" -eq 0 ]; then
            echo "::error::No tokens were collected!"
            echo ""
            echo "Possible issues:"
            echo "1. You didn't complete the OAuth login in time"
            echo "2. The authentication process failed"
            echo "3. Network/firewall issues"
            echo ""
            echo "Please re-run the workflow and complete the authentication."
            exit 1
          fi
          
          echo ""
          echo "Collected token files:"
          ls -la "$AUTH_DIR"/qwen-*.json 2>/dev/null || true
          
          if [ "$TOKEN_COUNT" -lt "$NEEDED" ]; then
            echo "::warning::Only $TOKEN_COUNT of $NEEDED tokens were collected"
          fi
          
          echo "::endgroup::"

      # ---------- 10. Encrypt tokens ----------
      - name: Package and encrypt tokens
        run: |
          set -euo pipefail
          
          echo "::group::Encrypting tokens"
          
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # Copy all token files to temp directory
          cp "$AUTH_DIR"/qwen-*.json . 2>/dev/null || true
          
          TOKEN_COUNT=$(ls qwen-*.json 2>/dev/null | wc -l)
          echo "Packaging $TOKEN_COUNT token files..."
          
          # Create tarball
          tar -czf qwen-tokens.tar.gz qwen-*.json
          echo "Created tarball: $(ls -lh qwen-tokens.tar.gz)"
          
          # Encrypt with AES-256-CBC (matching strix-scan.yml decryption)
          # Using -pbkdf2 for key derivation (more secure)
          openssl enc -aes-256-cbc -salt -pbkdf2 \
            -in qwen-tokens.tar.gz \
            -out qwen-tokens.enc \
            -pass pass:'${{ github.event.inputs.encryption_password }}'
          
          echo "Encrypted file: $(ls -lh qwen-tokens.enc)"
          
          # Base64 encode for storage as GitHub secret
          base64 -w 0 qwen-tokens.enc > "$HOME/qwen-tokens.b64"
          
          echo "Base64 encoded file: $(ls -lh "$HOME/qwen-tokens.b64")"
          
          # Cleanup temp files
          rm -rf "$TEMP_DIR"
          
          echo "::endgroup::"

      # ---------- 11. Upload artifact ----------
      - name: Upload encrypted tokens
        uses: actions/upload-artifact@v4
        with:
          name: qwen-encrypted-tokens
          path: ~/qwen-tokens.b64
          retention-days: 7

      # ---------- 12. Show instructions ----------
      - name: Show usage instructions
        run: |
          TOKEN_COUNT=$(find "$AUTH_DIR" -maxdepth 1 -name 'qwen-*.json' 2>/dev/null | wc -l)
          
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## âœ… Token Collection Complete
          
          EOF
          
          echo "**Tokens collected:** $TOKEN_COUNT / ${{ github.event.inputs.num_accounts }}" >> $GITHUB_STEP_SUMMARY
          
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          
          ### ðŸ“¦ Next Steps
          
          1. **Download the artifact** `qwen-encrypted-tokens` from this workflow run
          
          2. **Get the base64 content** from the downloaded `qwen-tokens.b64` file
          
          3. **Create a repository secret** named `QWEN_TOKENS`:
             - Go to Settings â†’ Secrets and variables â†’ Actions
             - Click "New repository secret"
             - Name: `QWEN_TOKENS`
             - Value: Paste the entire content of `qwen-tokens.b64`
          
          4. **Run strix-scan.yml** with the same encryption password
          
          ### ðŸ” Security Notes
          
          - The artifact is encrypted with AES-256-CBC
          - Keep your encryption password safe - you'll need it for strix-scan.yml
          - The artifact expires in 7 days
          - Never share your tokens or encryption password
          
          ### ðŸ”„ To add more accounts later
          
          Re-run this workflow with a higher number of accounts. The new tokens will replace the old ones.
          EOF

      # ---------- 13. Cleanup sensitive files ----------
      - name: Cleanup
        if: always()
        run: |
          rm -rf "$AUTH_DIR"/qwen-*.json 2>/dev/null || true
          rm -f "$HOME/qwen-tokens.b64" 2>/dev/null || true
          rm -f /tmp/cliproxy-*.log /tmp/expect-*.log /tmp/auth-*.exp 2>/dev/null || true
          echo "Sensitive files cleaned up"
