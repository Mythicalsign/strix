name: Qwen Code Multi-Account Token Collection

on:
  workflow_dispatch:
    inputs:
      num_accounts:
        description: 'Number of Qwen Code accounts to authenticate'
        required: true
        default: '3'
        type: choice
        options: ['1','2','3','4','5','6','7','8','9','10']
      encryption_password:
        description: 'Password for encrypting tokens (remember this!)'
        required: true
        type: string

jobs:
  collect-tokens:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # ---------- 1.  install CLIProxyAPI ----------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install CLIProxyAPI
        run: |
          git clone https://github.com/luispater/CLIProxyAPI.git
          cd CLIProxyAPI
          sudo cp cli-proxy-api /usr/local/bin/cliproxyapi
          cd ..
          rm -rf CLIProxyAPI
          cliproxyapi --help          # quick sanity check

      # ---------- 2.  create per-account folders ----------
      - name: Create auth directory structure
        run: |
          AUTH_DIR="$HOME/.cli-proxy-api"
          mkdir -p "$AUTH_DIR"
          chmod 700 "$AUTH_DIR"
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            mkdir -p "$AUTH_DIR/account-$i"
            chmod 700 "$AUTH_DIR/account-$i"
          done

      # ---------- 3.  create per-account config ----------
      - name: Create config files for each account
        run: |
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            cat > config-account-$i.yaml <<EOF
          port: 8317
          auth-dir: "$HOME/.cli-proxy-api/account-$i"
          debug: true
          logging-to-file: true
          EOF
          done

      # ---------- 4.  authenticate sequentially ----------
      - name: Authenticate accounts sequentially
        run: |
          for i in $(seq 1 ${{ github.event.inputs.num_accounts }}); do
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“± ACCOUNT $i / ${{ github.event.inputs.num_accounts }}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            CONFIG="config-account-$i.yaml"
            ACCOUNT_DIR="$HOME/.cli-proxy-api/account-$i"

            # start server in background
            cliproxyapi -config "$CONFIG" -qwen-login > server-$i.log 2>&1 &
            SERVER_PID=$!

            sleep 8                                           # let it print URL
            AUTH_URL=$(grep -oP 'https://[^\s]+' server-$i.log | head -1)

            if [ -n "$AUTH_URL" ]; then
              echo "ðŸ‘‰ OPEN THIS URL IN YOUR BROWSER (you have 10 min):"
              echo "   $AUTH_URL"
            else
              echo "âš ï¸  Could not auto-detect URL; check server-$i.log"
            fi

            # wait for token file (max 10 min)
            for s in {1..600}; do
              if ls "$ACCOUNT_DIR"/qwen-*.json 2>/dev/null | grep -q .; then
                echo "âœ… Token detected for account $i"
                break
              fi
              sleep 1
            done

            # cleanup
            kill $SERVER_PID 2>/dev/null || true
            if [ ! -f "$ACCOUNT_DIR"/qwen-*.json ]; then
              echo "âŒ No token for account $i"; exit 1
            fi
            echo "â¸ï¸  5 s pause before next account..."; sleep 5
          done

      # ---------- 5.  verify & encrypt ----------
      - name: Verify and count tokens
        run: |
          TOKEN_COUNT=$(find "$HOME/.cli-proxy-api" -name 'qwen-*.json' | wc -l)
          echo "Tokens collected: $TOKEN_COUNT"
          [ "$TOKEN_COUNT" -eq 0 ] && echo "âŒ No tokens!" && exit 1

      - name: Collect and encrypt tokens
        run: |
          TEMP=$(mktemp -d)
          find "$HOME/.cli-proxy-api" -name 'qwen-*.json' -exec cp {} "$TEMP/" \;
          cd "$TEMP"
          tar -czf qwen-tokens.tar.gz qwen-*.json
          openssl enc -aes-256-cbc -salt -pbkdf2 \
            -in qwen-tokens.tar.gz -out qwen-tokens.enc \
            -pass pass:${{ github.event.inputs.encryption_password }}
          base64 -w 0 qwen-tokens.enc > "$HOME/qwen-tokens.b64"
          rm -rf "$TEMP"

      # ---------- 6.  upload artifact ----------
      - name: Upload encrypted tokens
        uses: actions/upload-artifact@v4
        with:
          name: qwen-encrypted-tokens
          path: ~/qwen-tokens.b64
          retention-days: 1

      - name: Job summary
        run: |
          echo "## âœ…  All ${{ github.event.inputs.num_accounts }} Qwen tokens collected & encrypted" >> $GITHUB_STEP_SUMMARY
          echo "Upload the artifact **qwen-encrypted-tokens** to your secret store and remember the encryption password!" >> $GITHUB_STEP_SUMMARY
